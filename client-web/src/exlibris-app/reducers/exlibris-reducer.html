<!--
  ~ Copyright 2018, TeamDev Ltd. All rights reserved.
  ~
  ~ Redistribution and use in source and/or binary forms, with or without
  ~ modification, must retain the above copyright notice and the following
  ~ disclaimer.
  ~
  ~ THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  ~ "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  ~ LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
  ~ A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
  ~ OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  ~ SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  ~ LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
  ~ DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
  ~ THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  ~ (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  ~ OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  -->
<script src="../test_values.js"></script>
<script src="./loading-status.js"></script>
<link rel="import" href="../book/book-values.html">
<link rel="import" href="../actions/exlibris-actions.html">
<script src="./loading-status.js"></script>
<link rel="import" href="../actions/exlibris-action.html">

<script>
    /* exported reducer */
    /*global userTestBooks libraryTestBooks expectedSoonLibraryBooks testCategories*/
    {
        const initialState = {
            overdueBooks: [...userTestBooks.overdue],
            borrowedBooks: [...userTestBooks.overdue, ...userTestBooks.borrowed],
            shouldReturnBooks: userTestBooks.shouldReturnSoon,
            reservedBooks: userTestBooks.reserved,
            allBooks: [...userTestBooks.overdue, ...libraryTestBooks],
            expectedSoonBooks: expectedSoonLibraryBooks,
            bookDetails: {
                book: {},
                loadingStatus: {}
            },
            categories: testCategories

        };

        ExlibrisApp.reducer = (state = initialState, action) => {
            switch (action.type) {
                case ExlibrisApp.ExlibrisActions.FETCH_BOOKS: {
                    //TODO:2018-55-17:yurii.haidamaka add data loading from the server
                    return state;
                }
                case ExlibrisApp.ExlibrisActions.FIND_BOOK_BY_ID: {
                    const id = action.bookId;
                    const book = findElement(id, state.allBooks, state.expectedSoonBooks, state.borrowedBooks, state.reservedBooks);
                    if (book) {
                        return Object.assign({}, state, {
                            bookDetails: {
                                book: book,
                                loadingStatus: ExlibrisApp.LoadingStatus.COMPLETED
                            }
                        });
                    }
                    return Object.assign({}, state, {
                        bookDetails: {
                            book: {},
                            loadingStatus: ExlibrisApp.LoadingStatus.NOT_FOUND
                        }
                    });
                }

                case ExlibrisApp.ExlibrisActions.RESERVE_BOOK: {
                    //TODO:2018-21-18:yegor.udovchenko: request reservation
                    return state;
                }

                case ExlibrisApp.ExlibrisActions.CANCEL_BOOK_RESERVATION: {
                    //TODO:2018-21-18:yegor.udovchenko: request cancel reservation
                    return state;
                }

                case ExlibrisApp.ExlibrisActions.EXTEND_LOAN_PERIOD: {
                    //TODO:2018-22-18:yegor.udovchenko: request loan extension
                }
                case ExlibrisApp.ExlibrisActions.FILTER_BY_CATEGORY: {
                    //TODO:2018-51-27:yurii.haidamaka Add requests to the server

                    /*for now we filter the test data*/
                    const category = action.category;
                    const filteredBooks = libraryTestBooks.filter(
                        b => b.category === category);
                    return Object.assign({}, state, {allBooks: filteredBooks});
                }
                case ExlibrisApp.ExlibrisActions.SEARCH_BY_QUERY: {
                    //TODO:2018-51-27:yurii.haidamaka Add requests to the server

                    /*for now we sort the test data*/
                    const query = action.query.toLowerCase();
                    const filteredBooks = libraryTestBooks.filter(
                        b => b.title.toLowerCase().includes(query) ||
                            b.author.toLowerCase().includes(query) || b.description.toLowerCase().includes(query));
                    return Object.assign({}, state, {allBooks: filteredBooks});
                }
                case ExlibrisApp.ExlibrisActions.RESET_FILTERS: {
                    const allBooks = [...state.overdueBooks, ...libraryTestBooks]
                    return Object.assign({}, state, {allBooks: allBooks});
                }
                case ExlibrisApp.ExlibrisActions.FETCH_BOOKS: {
                    //TODO:2018-55-17:yurii.haidamaka add data loading from the server
                    return state;
                }

                default:
                    return state;
            }
        };

        function findElement(id) {
            let element;
            let i = 1;
            while (!element && i < arguments.length) {
                if (Array.isArray(arguments[i])) {
                    const filteredArray = arguments[i].filter(x => x.id === id);
                    if (filteredArray.length > 0) {
                        element = filteredArray[0];
                    }
                }
                i++;
            }
            return element;
        }
    }
</script>
