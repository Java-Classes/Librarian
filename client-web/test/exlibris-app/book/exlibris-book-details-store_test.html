<!doctype html>
<!--
  ~ Copyright 2018, TeamDev Ltd. All rights reserved.
  ~
  ~ Redistribution and use in source and/or binary forms, with or without
  ~ modification, must retain the above copyright notice and the following
  ~ disclaimer.
  ~
  ~ THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  ~ "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  ~ LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
  ~ A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
  ~ OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  ~ SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  ~ LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
  ~ DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
  ~ THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  ~ (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  ~ OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  -->

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>exlibris-book-details store test</title>

    <script src="../../../bower_components/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../bower_components/web-component-tester/browser.js"></script>
    <script src="../../../node_modules/redux/dist/redux.js"></script>
    <script src="../test_variables.js"></script>

    <link rel="import" href="../../../src/exlibris-app/book/exlibris-book-details.html">
    <link rel="import" href="../../../src/exlibris-app/book/book-values.html">
    <link rel="import" href="../../../src/exlibris-app/actions/exlibris-actions.html">

</head>
<body>

<test-fixture id="BasicTestFixture">
    <template>
        <exlibris-book-details></exlibris-book-details>
    </template>
</test-fixture>

<script>
    suite('exlibris-book-details', function () {
        const TEST_BOOK = ExlibrisAppTest.BOOKS[0];
        const TEST_BOOK_ROUTE = {
            prefix: '/book-details',
            path: '/' + TEST_BOOK.title.replace(/\s/g, '_') + '/' + TEST_BOOK.id
        };

        const BOOK_DETAILS_SELECTORS = {
            WIDE_SCREEN_BUTTON: '.book-card .head-part .book-details .details-action-part paper-button',
        };

        let mockStore;

        setup(() => {
            mockStore = sinon.mock(ExlibrisApp.store);
        });

        teardown(() => {
            mockStore.restore();
        });

        test('should react on route change and dispatch `FIND_BOOK_BY_ID` action to the store.', function () {
            const expectedAction = {
                type: ExlibrisApp.ExlibrisActions.FIND_BOOK_BY_ID,
                bookId: TEST_BOOK.id
            };
            mockStore.expects("dispatch").once().withArgs(expectedAction);
            const element = fixture('BasicTestFixture');
            element.set('route', TEST_BOOK_ROUTE);

            mockStore.verify();
        });

        test('should dispatch `RESERVE_BOOK` action to the store on `RESERVE` button click.', function () {
            const expectedAction = {
                type: ExlibrisApp.ExlibrisActions.RESERVE_BOOK,
                bookId: TEST_BOOK.id
            };
            const bookForReservation = Object.assign({}, TEST_BOOK, {status: ExlibrisApp.BookStatus.EXPECTED});
            const testState = {
                bookDetails: {
                    book: bookForReservation
                }
            };

            mockStore.expects("getState").returns(testState);
            mockStore.expects("dispatch").once().withArgs(expectedAction);
            const element = fixture('BasicTestFixture');

            const wideScreenButton = element.shadowRoot.querySelector(BOOK_DETAILS_SELECTORS.WIDE_SCREEN_BUTTON);
            wideScreenButton.click();
            mockStore.verify();
        });

        test('should dispatch `CANCEL_BOOK_RESERVATION` action to the store on `CANCEL RESERVATION` button click.', function () {
            const expectedAction = {
                type: ExlibrisApp.ExlibrisActions.CANCEL_BOOK_RESERVATION,
                bookId: TEST_BOOK.id
            };
            const bookForReservation = Object.assign({}, TEST_BOOK, {status: ExlibrisApp.BookStatus.RESERVED});
            const testState = {
                bookDetails: {
                    book: bookForReservation
                }
            };

            mockStore.expects("getState").returns(testState);
            mockStore.expects("dispatch").once().withArgs(expectedAction);
            const element = fixture('BasicTestFixture');

            const wideScreenButton = element.shadowRoot.querySelector(BOOK_DETAILS_SELECTORS.WIDE_SCREEN_BUTTON);
            wideScreenButton.click();
            mockStore.verify();
        });

        test('should dispatch `EXTEND_LOAN_PERIOD` action to the store on `EXTEND LOAN PERIOD` button click.', function () {
            const expectedAction = {
                type: ExlibrisApp.ExlibrisActions.EXTEND_LOAN_PERIOD,
                bookId: TEST_BOOK.id
            };
            const bookForReservation = Object.assign({}, TEST_BOOK, {status: ExlibrisApp.BookStatus.BORROWED, isAllowedLoanExtension: true});
            const testState = {
                bookDetails: {
                    book: bookForReservation,
                    loadingStatus: ExlibrisApp.LoadingStatus.COMPLETED
                }
            };

            mockStore.expects("getState").returns(testState);
            mockStore.expects("dispatch").once().withArgs(expectedAction);
            const element = fixture('BasicTestFixture');

            const wideScreenButton = element.shadowRoot.querySelector(BOOK_DETAILS_SELECTORS.WIDE_SCREEN_BUTTON);
            wideScreenButton.click();
            mockStore.verify();
        });

        test('should react on `loadingStatus` change and dispatch the custom event when the value is `LoadingStatus.NOT_FOUND`.', function (done) {
            const testState = {
                bookDetails: {
                    book: {},
                    loadingStatus: ExlibrisApp.LoadingStatus.NOT_FOUND
                }
            };
            const stub = sinon.stub(ExlibrisApp.store, "getState");
            stub.onFirstCall().returns({}).onSecondCall().returns(testState);

            const element = fixture('BasicTestFixture');
            element.addEventListener('exlibris-book-details-not-found', () => {
                done();
            });
            element.set('route', TEST_BOOK_ROUTE);

            stub.restore();
        });
    });
</script>
</body>
</html>
